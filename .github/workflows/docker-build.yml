name: Build and Push Docker Image to GHCR

# è§¦å‘æ¡ä»¶ï¼šä»…åœ¨ main åˆ†æ”¯æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
    branches:
      - main
    inputs:
      tag:
        description: 'Image tag (default: date-based)'
        required: false
        default: ''
        type: string

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: read      # è¯»å–ä»“åº“å†…å®¹
  packages: write     # å†™å…¥åŒ…ï¼ˆæ¨é€åˆ° GHCRï¼‰

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨
    
    steps:
    # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0        # è·å–å®Œæ•´çš„ Git å†å²ï¼ˆç”¨äºç‰ˆæœ¬ä¿¡æ¯ï¼‰
    
    # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºï¼‰
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64    # æ”¯æŒ AMD64 å’Œ ARM64 æ¶æ„
    
    # ç¬¬ä¸‰æ­¥ï¼šç™»å½•åˆ° GitHub Container Registry
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    # ç¬¬å››æ­¥ï¼šè½¬æ¢ä»“åº“åä¸ºå°å†™
    - name: Set lowercase image name
      id: image-name
      run: echo "IMAGE_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
    
    # ç¬¬äº”æ­¥ï¼šæå–é•œåƒå…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œæ ‡ç­¾ï¼‰
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ steps.image-name.outputs.IMAGE_NAME }}
        tags: |
          # é»˜è®¤çš„ latest æ ‡ç­¾ï¼ˆä¼šè‡ªåŠ¨æ›´æ–°ï¼‰
          type=raw,value=latest
          # åŸºäºæ—¥æœŸçš„é»˜è®¤æ ‡ç­¾
          type=raw,value={{date 'YYYYMMDD-HHmmss'}}
          # main åˆ†æ”¯æ ‡ç­¾
          type=raw,value=main
          # å¦‚æœæä¾›äº†è‡ªå®šä¹‰æ ‡ç­¾åˆ™ä½¿ç”¨
          type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event.inputs.tag != '' }}
        labels: |
          # OCI æ ‡å‡†æ ‡ç­¾
          org.opencontainers.image.title=ok-time
          org.opencontainers.image.description=Simple time display page
          org.opencontainers.image.vendor=${{ github.repository_owner }}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created={{date 'iso8601'}}
    
    # ç¬¬å…­æ­¥ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .                      # æ„å»ºä¸Šä¸‹æ–‡ä¸ºå½“å‰ç›®å½•
        file: ./Dockerfile             # Dockerfile è·¯å¾„
        platforms: linux/amd64,linux/arm64  # å¤šå¹³å°æ„å»º
        push: true                     # æ„å»ºå®Œæˆåæ¨é€åˆ°ä»“åº“
        tags: ${{ steps.meta.outputs.tags }}     # ä½¿ç”¨æå–çš„æ ‡ç­¾
        labels: ${{ steps.meta.outputs.labels }} # ä½¿ç”¨æå–çš„æ ‡ç­¾
        cache-from: type=gha           # ä½¿ç”¨ GitHub Actions ç¼“å­˜
        cache-to: type=gha,mode=max    # å°†æ„å»ºç¼“å­˜ä¿å­˜åˆ° GitHub Actions
        build-args: |
          # ä¼ é€’æ„å»ºå‚æ•°
          BUILD_DATE={{date 'iso8601'}}
          VCS_REF=${{ github.sha }}
    
    # ç¬¬ä¸ƒæ­¥ï¼šè¾“å‡ºæ„å»ºç»“æœ
    - name: Output image details
      run: |
        echo "ğŸ‰ Docker image built and pushed successfully!"
        echo "ğŸ“¦ Image: ghcr.io/${{ steps.image-name.outputs.IMAGE_NAME }}"
        echo "ğŸ·ï¸  Tags: ${{ steps.meta.outputs.tags }}"
        echo "ğŸ”— Package URL: https://github.com/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }}"

  # å¯é€‰ï¼šéƒ¨ç½²éªŒè¯ä½œä¸š
  verify-deployment:
    name: Verify Image
    needs: build-and-push
    runs-on: ubuntu-latest
    if: success()  # ä»…åœ¨æ„å»ºæˆåŠŸåæ‰§è¡Œ
    
    steps:
    # ç¬¬ä¸€æ­¥ï¼šè½¬æ¢ä»“åº“åä¸ºå°å†™
    - name: Set lowercase image name
      id: image-name
      run: echo "IMAGE_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
    
    # ç¬¬äºŒæ­¥ï¼šéªŒè¯é•œåƒæ˜¯å¦å¯ä»¥æ­£å¸¸æ‹‰å–å’Œè¿è¡Œ
    - name: Pull and test image
      run: |
        # æ‹‰å–åˆšåˆšæ„å»ºçš„é•œåƒ
        docker pull ghcr.io/${{ steps.image-name.outputs.IMAGE_NAME }}:latest
        
        # è¿è¡Œå®¹å™¨è¿›è¡ŒåŸºæœ¬æµ‹è¯•
        docker run --rm -d --name ok-time-test -p 3000:3000 \
          ghcr.io/${{ steps.image-name.outputs.IMAGE_NAME }}:latest
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
        # æµ‹è¯•æœåŠ¡æ˜¯å¦å“åº”
        curl -f http://localhost:3000/ || exit 1
        
        # æ£€æŸ¥é¡µé¢æ ‡é¢˜æ˜¯å¦æ­£ç¡®
        if curl -s http://localhost:3000/ | grep -q "ok-time"; then
          echo "âœ… Service is working correctly!"
        else
          echo "âŒ Service test failed!"
          exit 1
        fi
        
        # æ¸…ç†æµ‹è¯•å®¹å™¨
        docker stop ok-time-test
    
    # ç¬¬ä¸‰æ­¥ï¼šè¾“å‡ºæœ€ç»ˆçš„ä½¿ç”¨è¯´æ˜
    - name: Usage instructions
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo ""
        echo "ğŸ“‹ Usage Instructions:"
        echo "   docker pull ghcr.io/${{ steps.image-name.outputs.IMAGE_NAME }}:latest"
        echo "   docker run -p 3000:3000 ghcr.io/${{ steps.image-name.outputs.IMAGE_NAME }}:latest"
        echo ""
        echo "ğŸŒ Access your application at: http://localhost:3000"
        echo "ğŸ“¦ Package page: https://github.com/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }}"
